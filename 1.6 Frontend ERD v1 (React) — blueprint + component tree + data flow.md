## 1.6 Frontend ERD v1 (React) — blueprint + component tree + data flow

Goal: ship a modern ERD experience fast:

* one page to view ERD
* pan/zoom/select
* inspector panel
* overlay annotations (from 1.4)
* jump-to from issues

Tech locked (v1): React + Vite + TS, Tailwind, Zustand, TanStack Query.

---

# 1.6.01 App Routes (minimal v1)

### Pages

1. **Dashboard**

* `/workspaces/:wsId/instances/:instanceId`
* shows rollups + issues list + “Open ERD” button

2. **ERD**

* `/workspaces/:wsId/instances/:instanceId/erd`
* loads snapshot + annotations
* renders diagram + inspector

---

# 1.6.02 Data Flow (ERD page)

### Inputs

* `instanceId` (URL)
* `targetDatabaseUrl` + `schemas[]` (v1: user enters in modal; later from connectionId stored secrets)

### Calls

1. `POST /api/v1/introspect/postgres/snapshot` → `snapshot`
2. `GET /api/v1/checklist-instances/:instanceId/annotations` → `annotations`
3. (optional) `GET /api/v1/checklist-instances/:instanceId/issues` → for side drawer “issues”

### Merge

* snapshot gives nodes + edges
* annotations gives severity badges for nodes/edges
* selection drives inspector

---

# 1.6.03 ERD State Model (Zustand)

Create store: `apps/web/src/stores/erdStore.ts`

State:

* `viewport`: `{ x, y, zoom }`
* `selected`: `{ type: 'table' | 'relationship' | null, key?: string }`
* `layout`: positions map `{ tableKey -> {x,y,w,h} }`
* `filters`: schemas, search, hideIsolated
* `focus`: a “spotlight” target for jump-to (from issues)
* `ui`: inspector open/closed, minimap on/off

Actions:

* `setSelected(...)`
* `setViewport(...)`
* `setTablePos(...)`
* `focusOnTable(schema, table)`
* `focusOnRelationship(signature)`
* `applyAutoLayout()` (basic grid layout v1)

---

# 1.6.04 Component Tree (ERD page)

### `ErdPage`

* loads snapshot + annotations
* sets initial layout (if empty)
* renders layout grid

Children:

1. `TopBar`

   * schema selector
   * search input
   * “Auto Layout”
   * “Reset View”
   * “Safe Mode toggle” (UI only v1)

2. `ErdCanvas` (main stage)

   * `ErdStage` (zoom/pan wrapper)
   * `EdgesLayer` (SVG)
   * `NodesLayer` (HTML absolutely positioned)
   * `SelectionOutlineLayer`

3. `InspectorPanel` (right)

   * Overview tab
   * Columns tab
   * Keys + Indexes tab
   * Relationships tab
   * Checklist tab (show failing checks affecting this table)

4. `IssuesDrawer` (optional left)

   * list of issues
   * clicking issue focuses table/edge

---

# 1.6.05 Rendering approach (fast + modern)

### Recommended: HTML nodes + SVG edges

* Nodes: div cards positioned absolute
* Edges: SVG path layer beneath nodes
* Pan/zoom: apply CSS transform on a single container

Why:

* Very fast to build
* Easy to style (Tailwind)
* Works fine for v1 graphs (100–250 tables)
* Can optimize later (canvas/WebGL)

---

# 1.6.06 Layout strategy (v1)

### v1 Auto Layout (simple but effective)

* group tables by schema
* each schema becomes a vertical “lane”
* within a schema, grid pack based on table count
* save positions in zustand (later persist to app DB)

Also provide:

* drag table to reposition
* positions persist in memory (persist later)

---

# 1.6.07 ERD UI design rules (modern feel)

**Look/feel:**

* background: subtle grid
* table cards: soft shadow, 2xl rounded, tight typography
* badges: severity pill (warning/fail/block)
* inspector: pinned right, clean tabs
* search: command palette vibe (Ctrl+K later)

---

# 1.6.08 Minimal types + adapters (frontend)

Create:
`apps/web/src/api/types.ts`

* mirror `PgSnapshot` and annotations shapes

Create:
`apps/web/src/api/client.ts`

* fetch wrapper (base URL)
* POST snapshot
* GET annotations

Create:
`apps/web/src/erd/graph.ts`

* convert snapshot → `TableNode[]`, `Edge[]`
* create keys:

  * `tableKey = schema + '.' + table`
  * `edgeKey = childSchema.childTable(childCols)->parentSchema.parentTable(parentCols)`

---

# 1.6.09 Implementation steps (do in order)

## Step A — ERD page scaffolding

* [ ] Create route `/workspaces/:wsId/instances/:instanceId/erd`
* [ ] Add layout with:

  * top bar
  * empty canvas container
  * inspector placeholder

## Step B — Snapshot loader UI (v1 modal)

* [ ] Modal asks:

  * targetDatabaseUrl
  * schemas (comma separated)
* [ ] Save to localStorage for dev speed
* [ ] Run snapshot request

## Step C — Draw table cards

* [ ] Render each table as a draggable card
* [ ] Show columns (collapsed default; expand on hover/selection)
* [ ] Click selects and opens inspector

## Step D — Draw FK edges

* [ ] For each FK edge, compute start/end anchors
* [ ] SVG cubic bezier
* [ ] Highlight on hover/selection
* [ ] If annotations say severe → thicker edge + colored dot

## Step E — Pan/zoom

* [ ] drag background pans
* [ ] mouse wheel zoom
* [ ] reset view button

## Step F — Overlay annotations

* [ ] Table badge: highest severity + count
* [ ] Relationship dots

## Step G — Jump-to from issues

* [ ] Issues drawer list
* [ ] Clicking issue focuses view + selects node

---

# 1.6.10 “Minimum shippable ERD v1”

You’re done when:

* user can load snapshot
* ERD shows nodes + edges
* pan/zoom works
* inspector shows selected table details
* annotations render (badges/dots)
* issue click focuses ERD

---

## If you want the next output:

Say **“1.6 code”** and I’ll generate the actual starter files:

* `ErdPage.tsx`
* `ErdCanvas.tsx`
* `erdStore.ts`
* `graph.ts`
* `api client hooks`
* basic layout + pan/zoom + drag nodes
