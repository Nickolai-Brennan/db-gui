## Checklist → ERD Binding Rules v1 (how issues paint the diagram)

This is the exact “glue” that makes your dashboard and ERD share one source of truth.

---

# 1) Core concept

Every checklist result becomes a **Graph Annotation** applied to:

* a **Table Node**
* a **Relationship Edge**
* or the **Canvas/Diagram** (global)

### Annotation structure

```ts
type Severity = "info" | "warning" | "error" | "blocking";

type Target =
  | { kind: "table"; schema: string; table: string }
  | { kind: "column"; schema: string; table: string; column: string }
  | { kind: "relationship"; fkName?: string; childSchema: string; childTable: string; childCols: string[]; parentSchema: string; parentTable: string; parentCols: string[] }
  | { kind: "diagram" };

interface Annotation {
  id: string;
  severity: Severity;
  code: string;        // e.g. FK_NOT_INDEXED
  title: string;       // short label
  detail?: string;     // longer text
  target: Target;
  suggestedFix?: {
    label: string;     // "Create index on FK"
    actionId: string;  // e.g. AUTO_CREATE_INDEX
    payload?: any;     // params for fixer
  };
}
```

---

# 2) Visual Encoding Rules (no chaos)

## 2.1 Severity visuals

* **blocking/error**: red badge + red edge dash highlight
* **warning**: amber badge + amber edge highlight
* **info**: blue/gray dot (optional)

**Important:** do *not* recolor entire table backgrounds. Use:

* header badge count
* subtle outline on selection/hover
* edge highlight only when relevant

## 2.2 Badge placement

### Table node

* Header right: `❌2` or `⚠1`
* Tooltip on hover shows top 3 issues

### Relationship edge

* Midpoint dot (colored by severity)
* Hover reveals mini popover with:

  * issue title
  * “Fix” button if available
  * “Details” opens inspector on relationship tab

### Column row

* Tiny icon on the column line (e.g., missing type, nullable mismatch)
* Clicking selects column and opens inspector → Columns tab

---

# 3) Mapping Rules (Checklist code → ERD target)

Below are the “canonical” mappings you should implement for v1.

## 3.1 Table-level issue codes

### `NO_PRIMARY_KEY`

* Target: `{kind:"table"}`
* Visual: table header badge increments
* Tooltip: “No primary key”
* Fix: open Table Inspector → Keys → “Set PK”

### `DUPLICATE_COLUMN_NAMES`

* Target: `{kind:"table"}`
* Fix: Inspector → Columns

### `RESERVED_KEYWORD_IDENTIFIER`

* Target: `{kind:"table"}` or `{kind:"column"}`
* Fix: rename suggestion; requires user confirm

### `UNSUPPORTED_TYPE`

* Target: `{kind:"column"}`
* Fix: show supported types list + “Edit SQL manually” option

---

## 3.2 Relationship-level issue codes

### `FK_BROKEN`

* Target: `{kind:"relationship"}`
* Visual: **red dashed edge**, endpoints highlighted
* Fix: open relationship editor, rebind columns

### `FK_NOT_INDEXED`

* Target: `{kind:"relationship"}` **and** `{kind:"table"}` on child table
* Visual:

  * edge warning dot
  * child table gets warning badge
* Fix (auto):

  * “Create index on (child_fk_cols)”
  * Generates `CREATE INDEX ... ON child(fk_cols)`

### `FK_HAS_VIOLATIONS`

* Target: relationship
* Visual: red edge dot + “broken/blocked” style (not dashed unless structurally broken)
* Fix:

  * opens Data Fix panel with violating row query

### `FK_REFERENCES_NON_UNIQUE_PARENT`

* Target: relationship
* Visual: red edge dot
* Fix:

  * suggest “Add unique constraint on parent columns” (unsafe if duplicates exist)
  * preflight duplicates query

### `RISKY_CASCADE`

* Target: relationship
* Visual: warning dot + ⚠ label on hover “ON DELETE CASCADE”
* Fix:

  * open relationship editor, change rule
  * show “impact estimate” if rowcount available

---

## 3.3 Data-entry readiness issue codes

### `FK_SELECTOR_NOT_CONFIGURED`

* Target: relationship or child table
* Visual: info/warn dot on edge
* Fix: open “Display column” configuration for FK selector

### `CHILD_PANEL_NOT_CONFIGURED`

* Target: table
* Fix: open Data Entry Settings for that table

---

# 4) Behavior Rules (how the ERD reacts)

## 4.1 Hover behavior

* Hover node:

  * highlight inbound/outbound edges
  * show compact issue tooltip with top issues
* Hover edge:

  * highlight endpoints
  * show issue popover + quick fix

## 4.2 Click behavior

* Click table badge:

  * opens Inspector “Validation” tab filtered to that table
* Click edge dot:

  * opens relationship editor + validation list

## 4.3 Focus mode (from dashboard)

When user clicks an issue on dashboard:

1. ERD opens
2. Canvas zooms to target
3. Target is selected
4. All unrelated elements dim to 20% opacity (“spotlight”)

This must feel instant.

---

# 5) Aggregation Rules (how parents count children)

Table badge count is computed as:

* all annotations targeting:

  * table
  * any column in the table
  * any relationship where table is child/parent (configurable)

Edge badge severity is computed as max severity among annotations targeting that edge.

---

# 6) Inspector “Validation” Tab (context-specific)

Add a tab that shows:

* list of annotations affecting the selected object
* each with:

  * severity badge
  * title
  * details
  * “Run check” (if automatic)
  * “Fix” (if available)
  * “View SQL” for the check query (optional)

---

# 7) Auto-fix execution rules (safe)

Auto-fixes are only allowed when:

* user is in **Edit mode**
* connection allows schema changes
* user confirms if fix modifies schema/data
* fix runs preflight checks first

Auto-fix always produces:

* SQL preview
* risk tag
* “Apply now” button

---

# 8) Default v1 Binding Set (minimum list)

Implement these first (high value):

* `NO_PRIMARY_KEY`
* `FK_NOT_INDEXED`
* `FK_HAS_VIOLATIONS`
* `FK_BROKEN`
* `FK_REFERENCES_NON_UNIQUE_PARENT`
* `RISKY_CASCADE`

Everything else can be v1.5.

---

If you want to keep going, next I can generate the **default checklist templates** (ERD Health, Migration Safety, Data Entry Readiness) fully populated with:

* item titles
* severity
* auto-check SQL (Postgres)
* fix actions

Say **“Templates”** and I’ll output them.
