## Default Checklist Templates v1 (ERD Health, Migration Safety, Data Entry Readiness)

These are **ready to use** templates (hierarchical) with:

* item titles
* severity + blocking rules
* what they target (table/relationship/diagram)
* auto-check SQL patterns (Postgres)
* recommended fixes (manual/auto)

You can store these as JSON templates and instantiate per **connection + schema scope + diagram**.

---

# Template 1 — ERD Health (Core Integrity)

## ERD Health

### 1) Tables

#### 1.1 Primary Keys

* **[BLOCKING][AUTO] All tables have a primary key**

  * Target: `table`
  * Check (find tables without PK):

    ```sql
    WITH tbl AS (
      SELECT n.nspname AS schema, c.relname AS table, c.oid AS oid
      FROM pg_class c
      JOIN pg_namespace n ON n.oid = c.relnamespace
      WHERE n.nspname = ANY(:schemas) AND c.relkind IN ('r','p')
    )
    SELECT t.schema, t.table
    FROM tbl t
    LEFT JOIN pg_constraint con
      ON con.conrelid = t.oid AND con.contype = 'p'
    WHERE con.oid IS NULL
    ORDER BY t.schema, t.table;
    ```
  * Fix:

    * Manual: choose PK columns
    * Auto (if `id` exists and is unique): propose `PRIMARY KEY (id)`

#### 1.2 Column basics

* **[ERROR][AUTO] No duplicate column names**

  * Target: `table`
  * Check:

    ```sql
    SELECT n.nspname AS schema, c.relname AS table, a.attname AS column, COUNT(*) AS n
    FROM pg_attribute a
    JOIN pg_class c ON c.oid = a.attrelid
    JOIN pg_namespace n ON n.oid = c.relnamespace
    WHERE n.nspname = ANY(:schemas) AND c.relkind IN ('r','p')
      AND a.attnum > 0 AND NOT a.attisdropped
    GROUP BY n.nspname, c.relname, a.attname
    HAVING COUNT(*) > 1;
    ```
  * Fix: manual (rename)

* **[WARNING][AUTO] No reserved keywords used as identifiers**

  * Target: `table/column`
  * Check: (v1 lightweight)

    * maintain a local reserved-word list and compare against table/column names
  * Fix: manual rename

---

### 2) Relationships

#### 2.1 Structural validity

* **[BLOCKING][AUTO] No broken foreign keys in diagram**

  * Target: `relationship`
  * Check:

    * Compare ERD edge refs to catalog snapshot.
    * “Broken” if referenced table/column missing.
  * Fix: rebind relationship or remove edge

#### 2.2 Referential integrity

* **[BLOCKING][AUTO] No FK violations**

  * Target: `relationship`
  * Check (generated per FK):

    ```sql
    -- tool generates the join predicate based on FK columns
    SELECT COUNT(*) AS violating_rows
    FROM {child_schema}.{child_table} c
    LEFT JOIN {parent_schema}.{parent_table} p
      ON ({join_predicate})
    WHERE ({child_not_null_predicate})
      AND ({parent_null_predicate});
    ```
  * Fix options:

    * Set violating FK values to NULL (if nullable)
    * Delete violating rows
    * Map to valid parent keys (bulk editor)

#### 2.3 Parent uniqueness

* **[ERROR][AUTO] FK references a unique/PK parent key**

  * Target: `relationship`
  * Check:

    * For each FK parent column set, confirm it matches:

      * PK columns OR a UNIQUE constraint columns
  * Fix:

    * Add UNIQUE constraint (after duplicate precheck)
    * Or repoint FK to correct parent key

#### 2.4 Performance

* **[WARNING][AUTO] All FK columns are indexed (child side)**

  * Target: `relationship` + child `table`
  * Check:

    * For each FK, ensure an index exists whose leading columns match FK columns
  * Fix (auto):

    ```sql
    CREATE INDEX {child_table}_{fkcols}_idx
    ON {child_schema}.{child_table} ({fk_cols_csv});
    ```

#### 2.5 Risk policy

* **[WARNING][AUTO] No risky cascades on core entities**

  * Target: `relationship`
  * Check:

    * flag if `ON DELETE CASCADE` and:

      * parent table is tagged “core” (user tag), OR
      * parent has large row count threshold
  * Fix: change ON DELETE rule to RESTRICT/NO ACTION

---

### 3) Diagram hygiene

* **[INFO][MANUAL] Tables are grouped by domain**
* **[INFO][MANUAL] Notes exist for non-obvious modeling decisions**
* **[INFO][AUTO] No orphan tables (optional)**

  * Orphan = no inbound/outbound relationships
  * Useful as info, not blocking

---

# Template 2 — Migration Safety (Apply Gate)

## Migration Safety Checklist

### 1) Preflight checks (Blocking)

* **[BLOCKING][AUTO] No NOT NULL violations for planned SET NOT NULL**

  * Target: migration step
  * Check (generated per planned column):

    ```sql
    SELECT COUNT(*) AS nulls
    FROM {schema}.{table}
    WHERE {column} IS NULL;
    ```
  * Fix: backfill data / keep nullable

* **[BLOCKING][AUTO] No duplicate violations for planned UNIQUE constraints**

  * Target: migration step
  * Check:

    ```sql
    SELECT {cols_csv}, COUNT(*) n
    FROM {schema}.{table}
    GROUP BY {cols_csv}
    HAVING COUNT(*) > 1
    LIMIT 50;
    ```
  * Fix: dedupe or adjust constraint

* **[BLOCKING][AUTO] No FK violations before adding FK constraints**

  * Uses ERD Health FK violation checks

### 2) Lock & runtime risk (Warnings/Errors)

* **[WARNING][AUTO] Large table operations flagged**

  * Target: migration step
  * Logic:

    * if `est_rows > threshold` and operation is ALTER/ADD CONSTRAINT
  * Fix: schedule maintenance window, add concurrently indexes first

* **[WARNING][AUTO] Indexes created concurrently where applicable**

  * Target: migration plan
  * Check:

    * if new index on existing large table, require CONCURRENTLY
  * Fix: generate `CREATE INDEX CONCURRENTLY`

### 3) High-risk operations (Hard gate by environment)

* **[BLOCKING in Prod][AUTO] No DROP/TYPE CHANGE without Unsafe Mode**

  * Target: migration plan
  * Logic:

    * if any step contains drop/alter type/rename → requires Unsafe Mode
  * Fix: enable Unsafe Mode + add explicit approvals

### 4) Review & audit (Manual)

* **[ERROR][MANUAL] SQL migration preview reviewed**
* **[INFO][MANUAL] Rollback plan documented** (v1.5+)

---

# Template 3 — Data Entry Readiness (Human UX)

## Data Entry Readiness

### 1) Table usability

* **[WARNING][AUTO] Tables have a stable primary key**

  * Target: table
  * Check: PK exists + not composite (optional warning)
  * Fix: add surrogate key (optional)

* **[INFO][AUTO] Default sort key defined**

  * Target: table
  * Logic:

    * default = PK desc, else created_at desc if exists
  * Fix: configure

### 2) FK selectors (Critical for UX)

* **[WARNING][MANUAL/HYBRID] FK display labels configured**

  * Target: relationship
  * Rule:

    * must define display columns for parent lookups (name/code)
  * Fix: choose label columns + preview dropdown results

* **[INFO][AUTO] FK selector queries are indexed**

  * Target: parent table
  * Rule:

    * if label column used in ILIKE search heavily, recommend trigram index (v1.5)
  * Fix: optional

### 3) Child panels

* **[INFO][MANUAL] Child panels enabled for core relationships**

  * Target: table
  * Fix: toggle child tabs in Data View

### 4) Validation rules

* **[WARNING][MANUAL] Required fields enforced in forms**

  * Target: table
  * Rule:

    * NOT NULL columns appear as required in UI
  * Fix: bind UI validation to schema

### 5) Audit & safety (optional v1, stronger v1.5)

* **[INFO][MANUAL] Writes disabled in Prod by default**
* **[INFO][AUTO] All writes are parameterized** (enforced by tool)

---

# Output Format Suggestion (Template JSON shape)

Each template can be stored as:

* `templateId`, `version`, `rootNode`

Each node:

* `title`, `children[]` or `item`

Each item:

* `type`, `severity`, `blocking`, `target`, `checkId`, `sqlTemplate`, `fixAction`

If you want, I can output these templates as **exact JSON** matching the builder model you’ll implement.

---

## Next: Checklist Builder UI (the actual “builder” experience)

I can now spec:

* left tree editor (sections/subsections/items)
* item editor (severity, type, SQL, fix)
* template versioning
* import/export

Say **“Builder UI”** and I’ll design it end-to-end.
