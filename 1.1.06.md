## Step 1.1.06 — Catalog Snapshot Service (Postgres Introspection) (exact)

Goal: build the **authoritative metadata ingestion layer** that powers:
- ERD generation
- Checklist automatic checks
- Migration diffs
- Data entry FK awareness

This service produces a **CatalogSnapshot** and persists it to `app_catalog_snapshot`.

Reference: ERD Spec v1 — Part 3 (Postgres introspection SQL). 

---

# 1.1.06a) Snapshot contract (authoritative)

The snapshot payload MUST be deterministic and stable.

```ts
type CatalogSnapshot = {
  capturedAt: string;
  schemas: string[];
  tables: TableMeta[];
  relationships: ForeignKeyMeta[];
  indexes: IndexMeta[];
};

type TableMeta = {
  schema: string;
  name: string;
  rowEstimate: number;
  bytes: number;
  columns: ColumnMeta[];
  primaryKey?: { columns: string[] };
  uniques: { name: string; columns: string[] }[];
};

type ColumnMeta = {
  name: string;
  dataType: string;
  nullable: boolean;
  default?: string;
};

type ForeignKeyMeta = {
  name: string;
  child: { schema: string; table: string; columns: string[] };
  parent: { schema: string; table: string; columns: string[] };
  onDelete: string;
  deferrable: boolean;
};

type IndexMeta = {
  schema: string;
  table: string;
  name: string;
  columns: string[];
  unique: boolean;
  predicate?: string;
};
```

---

# 1.1.06b) Introspection queries (minimum v1)

You must fetch:

1) Tables + size + row estimates
2) Columns + nullability + defaults
3) PK + unique constraints
4) Foreign keys
5) Indexes

Use **system catalogs**, not `information_schema` for performance.

(Use the SQL from ERD Spec v1 — Part 3 verbatim.)

---

# 1.1.06c) Snapshot pipeline

Steps:
1) Resolve schema scope (e.g. `public`, `stats`)
2) Run introspection queries
3) Normalize identifiers (`schema.table.column`)
4) Sort arrays deterministically
5) Compute fingerprint hash
6) Persist snapshot

Fingerprint rule:
- Same schema state → same fingerprint
- Any structural change → different fingerprint

---

# 1.1.06d) Refresh modes

Implement:
- **Refresh all schemas**
- **Refresh visible schemas only**
- **Manual refresh only** (v1 acceptable)

Store `captured_at` and show “Last refreshed” in UI.

---

# Done criteria for 1.1.06

✅ Snapshot JSON matches contract  
✅ Same DB state → same fingerprint  
✅ Snapshot loads ERD without extra DB hits  
✅ Checklist engine consumes snapshot only (no live DB queries)

---
