## 2.5 Data Model Additions (to support 2.1–2.4 cleanly)

### 2.5.01 Templates + Versions

* `checklist_templates`

  * `id, workspace_id, slug, name, description, tags jsonb, default_scope_type, is_archived, created_at, updated_at`
* `checklist_template_versions`

  * `id, template_id, label, notes, status(draft|published), created_at, published_at, published_by`

### 2.5.02 Nodes (tree)

* `checklist_nodes`

  * `id, template_version_id, parent_id nullable, node_type(section|group|item), title, description, sort_order int`
  * Item fields (nullable unless node_type=item):

    * `item_type(manual|automatic|hybrid)`
    * `severity(blocking|error|warning)`
    * `required bool`
    * `scope_type(schema|table|diagram)`
    * `target_selector jsonb` (ex: allTables / bySchema / byRegex)
    * `check_kind(builtin|sql)`
    * `check_ref text` (builtin id OR sql id)
    * `sql_template text`
    * `pass_fail_rule jsonb`
    * `result_mapping jsonb` (how to map query output → target_ref)
    * `fix_kind(instruction|sql)`
    * `fix_instructions text`
    * `fix_sql text`
* Constraints:

  * `sort_order` index on `(template_version_id, parent_id, sort_order)`

### 2.5.03 Instances + Results (runtime)

* `checklist_instances`

  * `id, workspace_id, template_version_id, scope_type, scope_ref jsonb, status, rollup jsonb, created_by, created_at, updated_at, last_run_at`
* `checklist_instance_results`

  * `id, instance_id, node_id`
  * `status(pass|warning|fail|blocked|unchecked)`
  * `severity(blocking|error|warning)`
  * `run_type(automatic|manual)`
  * `checked_by, note`
  * `ran_at, duration_ms`
  * `output_summary text`
  * `output_stats jsonb`
  * `output_rows jsonb`
  * `target_ref jsonb`  ← normalized `{ targets: [...] }`
  * `updated_at`
* `checklist_evidence` (optional)

  * `id, result_id, type(link|text), label, value, created_at`

### 2.5.04 ERD Layouts (we did)

* `erd_layouts(instance_id, table_key, x,y,w,h, updated_at)`

---

## 2.6 Route Map (Full Minimum-to-Ship)

### Templates

* `GET  /api/v1/workspaces/:wsId/checklist-templates`
* `POST /api/v1/workspaces/:wsId/checklist-templates`
* `PATCH /api/v1/checklist-templates/:templateId`

### Versions

* `GET  /api/v1/checklist-templates/:templateId/versions`
* `POST /api/v1/checklist-templates/:templateId/versions`
* `POST /api/v1/checklist-template-versions/:versionId/publish`

### Nodes

* `GET    /api/v1/checklist-template-versions/:versionId/nodes/tree`
* `POST   /api/v1/checklist-template-versions/:versionId/nodes`
* `PATCH  /api/v1/checklist-nodes/:nodeId`
* `DELETE /api/v1/checklist-nodes/:nodeId`
* `POST   /api/v1/checklist-template-versions/:versionId/nodes/reorder`

### Instances

* `POST /api/v1/workspaces/:wsId/checklist-instances`
* `GET  /api/v1/checklist-instances/:instanceId`
* `GET  /api/v1/checklist-instances/:instanceId/tree`
* `GET  /api/v1/checklist-instances/:instanceId/issues`

### Results + Evidence

* `PATCH /api/v1/checklist-instance-results/:resultId`
* `POST  /api/v1/checklist-instance-results/:resultId/evidence` (optional)

### Checks runtime

* `POST /api/v1/checklist-instances/:instanceId/run` (all / selected)
* `POST /api/v1/sql/test` (builder)

### ERD binding

* `POST /api/v1/introspect/postgres/snapshot`
* `GET  /api/v1/checklist-instances/:instanceId/annotations`
* `GET  /api/v1/checklist-instances/:instanceId/erd-layout`
* `PUT  /api/v1/checklist-instances/:instanceId/erd-layout`

---

## 2.7 Hard Rules (so the system stays sane)

### 2.7.01 Published version immutability

On every nodes mutation route:

* fetch `template_version.status`
* if `published` → **409 Conflict** with message `VERSION_IMMUTABLE`

### 2.7.02 Tree constraints (no cycles)

On reorder/move:

* build ancestry check:

  * newParentId cannot equal nodeId
  * newParentId cannot be any descendant of nodeId

### 2.7.03 “Item fields only on item nodes”

On create/update:

* if `node_type !== item`, strip item fields or reject

### 2.7.04 Result row guaranteed per item node

On instance creation:

* for each template node where node_type=item

  * upsert into `checklist_instance_results(instance_id, node_id)` status `unchecked`

---

## 2.8 Next: Implement the missing pieces you’ll need to “ship”

You already have: **runner**, **annotations**, **introspection**, **layout endpoints**, **ERD UI**.

The *two* backend things that unlock your checklist builder + “SQL checks” are:

### 2.8.01 SQL Template Runner (engine)

Needed for:

* sql-type nodes
* runtime execution under `/run`

**Core features**

* safe interpolation:

  * allow only placeholders like `{{schema}}`, `{{table}}`, `{{threshold.xyz}}`
  * reject unknown placeholders
* hard limits:

  * statement timeout (per session)
  * row cap (`LIMIT`)
* mapping:

  * map result columns to target refs using `result_mapping`
  * fall back to suggestions if mapping missing

### 2.8.02 `/api/v1/sql/test` (builder endpoint)

Needed for:

* user pastes SQL → you run it → show sample rows → suggest mapping fields

---

## 2.9 What I’ll output next (pick one, I’ll go straight into code)

Say one of these and I’ll paste the actual backend files:

1. **“2.3 SQL runner code”**

   * interpolator
   * timeout + row cap
   * mapping + target_ref builder
   * integrate into `/run`

2. **“2.3 SQL test endpoint code”**

   * `POST /api/v1/sql/test`
   * returns rows + columns + mapping suggestions

3. **“2.1 Templates/Versions/Nodes routes code”**

   * full Fastify routes + validators + cycle check + publish immutability

If you don’t pick, I’ll assume **(1)** because it’s the biggest blocker to “ship.”
