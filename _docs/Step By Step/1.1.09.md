## Step 1.1.09 — Checklist Engine Runtime (Execution + Rollups) (exact)

Goal: implement the **runtime engine** that executes checklist nodes,
computes rollups, and persists results that power:
- Dashboard status
- Issues queue
- ERD annotations
- Apply gating

This step turns templates into **live control planes**.

---

# 1.1.09a) Runtime inputs

A checklist run requires:
- `ChecklistInstance`
- `TemplateVersion`
- `CatalogSnapshot`
- Optional: `MigrationPlan`

No runtime step may query the database schema directly.
All automatic checks must use the snapshot.

---

# 1.1.09b) Execution phases

Execution is deterministic and ordered:

1. Resolve runnable nodes
2. Execute automatic checks
3. Merge manual results
4. Compute leaf statuses
5. Roll up group statuses
6. Persist counts + status

---

# 1.1.09c) Runnable node selection

Rules:
- Skip group nodes
- Skip items with runPolicy not matching trigger
- Skip manual-only items unless explicitly marked

Triggers:
- onRefresh
- onApplyAttempt
- onDemand

---

# 1.1.09d) Leaf result rules (authoritative)

Automatic items:
- 0 results → PASS
- 1+ results:
  - severity=info → WARNING
  - severity=warning → WARNING
  - severity=error → FAIL
  - severity=blocking → BLOCKED

Manual items:
- unchecked → INCOMPLETE
- checked pass → PASS
- checked fail → FAIL/BLOCKED based on severity

Persist one `checklist_instance_result` per node.

---

# 1.1.09e) Group rollup rules

For each group node, compute status from children:

Priority order:
1) BLOCKED
2) FAIL
3) WARNING
4) PASS
5) INCOMPLETE

Groups never store results directly; status is derived.

---

# 1.1.09f) Instance rollup

Compute:
- counts: {blocking, fail, warning, pass}
- overall status using same priority order
- `last_run_at`

Persist on `checklist_instance`.

---

# 1.1.09g) Idempotency guarantees

- Same snapshot + same template → same results
- Reruns overwrite previous results for same instance
- Partial runs update only targeted nodes

---

# Done criteria for 1.1.09

✅ Automatic checks execute from snapshot only  
✅ Manual results merge cleanly  
✅ Group + instance rollups are correct  
✅ Dashboard reflects instance state immediately  

---
