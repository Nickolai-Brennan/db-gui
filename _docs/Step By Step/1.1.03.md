## Step 1.1.03 — Checklist → ERD Annotation API (single source of truth) (exact)

Goal: implement the **one bridge** that makes Dashboard + ERD + Inspector share the same truth.

You already defined binding rules. This step turns those rules into:

- a backend resolver that emits `Annotation[]`
- a stable deep-link contract (focus mode)
- UI overlays (badges + edge dots)

Reference: Checklist → ERD Binding Rules v1. fileciteturn0file0

---

# 1.1.03a) Shared Types (place in `@db-gui/shared`)

Create or confirm the exact types exist:

```ts
export type Severity = "info" | "warning" | "error" | "blocking";

export type TargetRef =
  | { kind: "diagram" }
  | { kind: "table"; schema: string; table: string }
  | { kind: "column"; schema: string; table: string; column: string }
  | {
      kind: "relationship";
      fkName?: string;
      childSchema: string;
      childTable: string;
      childCols: string[];
      parentSchema: string;
      parentTable: string;
      parentCols: string[];
    };

export interface Annotation {
  id: string;
  severity: Severity;
  code: string;
  title: string;
  detail?: string;
  target: TargetRef;
  suggestedFix?: { label: string; actionId: string; payload?: any };
  deepLink?: {
    route: "erd";
    diagramId: string;
    focus: TargetRef;
    spotlight?: boolean;
  };
}
```

---

# 1.1.03b) Backend endpoint (exact)

Create:

```
GET /api/diagrams/:diagramId/annotations?instanceId=...
```

Rules:
- `diagramId` selects layout + catalog scope
- `instanceId` selects the checklist run results to visualize
- API returns a single payload:

```json
{
  "diagramId": "...",
  "instanceId": "...",
  "counts": { "blocking": 2, "warning": 5, "error": 0, "info": 1 },
  "annotations": [ /* Annotation[] */ ]
}
```

---

# 1.1.03c) Resolver logic (authoritative)

The resolver must:

1) load instance results that are not PASS
2) for each failing result:
   - map to ERD `targetRef` (table/column/relationship/diagram)
   - attach fixAction if present
   - attach deepLink for spotlight mode

Pseudo-code:

```ts
function toAnnotation(resultRow): Annotation {
  return {
    id: resultRow.id,
    severity: resultRow.severity,
    code: resultRow.code,
    title: resultRow.title,
    detail: resultRow.detail ?? undefined,
    target: resultRow.target_ref,
    suggestedFix: resultRow.suggested_fix ?? undefined,
    deepLink: {
      route: "erd",
      diagramId: resultRow.diagram_id,
      focus: resultRow.target_ref,
      spotlight: true
    }
  };
}
```

---

# 1.1.03d) Aggregation rules (table badges & edge dots)

These must match your binding doc:

### Table badge count
A table’s badge includes annotations targeting:
- the table itself
- any column in the table
- relationships where table is child/parent (configurable)

### Edge severity
Edge dot severity = max severity among annotations targeting that relationship.

(Implement as a pure function in shared utils for consistency.)

---

# 1.1.03e) ERD UI overlay (minimum viable)

In ERD renderer:

- each table node shows `badgeCount` and `maxSeverity`
- each relationship edge shows a dot if any issue targets it

Interactions (v1 minimum):
- hover table → tooltip “Top issues”
- click badge → open Inspector → Validation tab filtered
- click edge dot → open Relationship editor + Validation list
- dashboard click issue → ERD “spotlight” mode (dim others)

---

# 1.1.03f) Spotlight focus (deep link contract)

When user clicks an issue on the Dashboard, route to:

```
/erd/:diagramId?focus=<encoded TargetRef>&spotlight=1
```

Behavior:
1) ERD opens
2) zooms to target
3) selects target
4) dims unrelated objects to 20% opacity

---

# Done criteria for 1.1.03

✅ API returns Annotation[] matching binding rules  
✅ Dashboard issue click deep-links into ERD spotlight mode  
✅ Table badges show correct aggregated counts  
✅ Edge dots render and open correct inspector panels  
✅ Fix actions appear consistently in Dashboard + Inspector

---
