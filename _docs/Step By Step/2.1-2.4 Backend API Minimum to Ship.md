Got it. Below is the **Minimum-to-Ship Backend API** fully expanded into a **2.x spec** with concrete routes, payloads, validations, and “what the UI needs” notes—aligned with what we already built in 1.3–1.5 and what you listed.

---

## 2) Backend API Minimum to Ship

# 2.1 Templates API

## 2.1.01 GET templates (workspace)

**GET** `/api/v1/workspaces/:wsId/checklist-templates`

**Query**

* `q` (optional search)
* `status` (optional: `draft|published|archived`)
* `limit`, `offset`

**Response**

```json
{
  "templates": [
    {
      "id": "uuid",
      "workspaceId": "uuid",
      "slug": "erd-quality",
      "name": "ERD Quality Checklist",
      "description": "…",
      "tags": ["erd","postgres"],
      "defaultScopeType": "diagram",
      "isArchived": false,
      "createdAt": "iso",
      "updatedAt": "iso"
    }
  ]
}
```

---

## 2.1.02 POST template

**POST** `/api/v1/workspaces/:wsId/checklist-templates`

**Body**

```json
{
  "slug": "erd-quality",
  "name": "ERD Quality Checklist",
  "description": "Checks for relational integrity and modeling quality",
  "tags": ["erd", "postgres"],
  "defaultScopeType": "diagram"
}
```

**Rules**

* `slug` unique per workspace
* if `defaultScopeType` missing → `diagram`

---

## 2.1.03 PATCH template metadata

**PATCH** `/api/v1/checklist-templates/:templateId`

**Body** (partial)

```json
{
  "name": "…",
  "description": "…",
  "tags": ["…"],
  "isArchived": false
}
```

**Rules**

* Does **not** affect existing versions

---

## 2.1.04 POST create version (draft)

**POST** `/api/v1/checklist-templates/:templateId/versions`

**Body**

```json
{
  "label": "v1.0",
  "notes": "initial",
  "copyFromVersionId": "uuid (optional)"
}
```

**Behavior**

* Creates version with `status='draft'`
* If `copyFromVersionId`:

  * copy nodes tree (new IDs) preserving structure + sort_order
  * copy node fields including check definitions

---

## 2.1.05 POST publish version

**POST** `/api/v1/checklist-template-versions/:versionId/publish`

**Body**

```json
{ "publishedBy": "nick" }
```

**Rules**

* Published version becomes immutable:

  * all node CRUD + reorder must fail with 409
* Optional: enforce version has at least 1 node/item before publish

---

## 2.1.06 Nodes CRUD

### GET nodes (nested tree)

**GET** `/api/v1/checklist-template-versions/:versionId/nodes/tree`

**Response**

```json
{
  "versionId": "uuid",
  "roots": [
    {
      "id": "uuid",
      "nodeType": "section",
      "title": "Schema",
      "children": [
        {
          "id": "uuid",
          "nodeType": "item",
          "itemType": "automatic",
          "checkRef": "NO_PRIMARY_KEY",
          "severity": "warning",
          "children": []
        }
      ]
    }
  ]
}
```

### POST create node (group/item)

**POST** `/api/v1/checklist-template-versions/:versionId/nodes`

**Body**

```json
{
  "parentId": "uuid|null",
  "nodeType": "section|group|item",
  "title": "Foreign Keys",
  "description": "...",
  "sortOrder": 100,

  "item": {
    "itemType": "manual|automatic|hybrid",
    "severity": "blocking|error|warning",
    "required": true,
    "scopeType": "schema|table|diagram",
    "targetSelector": { "kind": "allTables" },
    "checkKind": "builtin|sql",
    "checkRef": "FK_NOT_INDEXED",
    "sqlTemplate": null,
    "passFailRule": { "type": "rowCount", "max": 0 },
    "fixKind": "instruction|sql",
    "fixInstructions": "Add index on FK columns…"
  }
}
```

**Rules**

* For `nodeType=item`, `item` required
* For `nodeType=section|group`, `item` must be omitted

### PATCH update node fields

**PATCH** `/api/v1/checklist-nodes/:nodeId`

**Body** (partial; can update item fields too)

```json
{
  "title": "…",
  "description": "…",
  "severity": "warning",
  "sqlTemplate": "SELECT …"
}
```

**Rules**

* if version published → 409

### DELETE node

**DELETE** `/api/v1/checklist-nodes/:nodeId`

**Rules**

* deletes subtree (or enforce leaf-only; your choice—v1 easiest is subtree)
* published → 409

### POST reorder/move nodes (batch)

**POST** `/api/v1/checklist-template-versions/:versionId/nodes/reorder`

**Body**

```json
{
  "moves": [
    { "nodeId": "uuid", "newParentId": "uuid|null", "newSortOrder": 120 }
  ]
}
```

**Rules**

* Validate no cycles:

  * newParentId cannot be node itself or descendant
* published → 409

---

# 2.2 Instances API

## 2.2.01 POST create instance

**POST** `/api/v1/workspaces/:wsId/checklist-instances`

**Body**

```json
{
  "connectionId": "uuid|null",
  "templateVersionId": "uuid",
  "scopeType": "diagram|schema|table|migration_step",
  "scopeRef": { "schemas": ["public"], "diagramId": "diag-1" },
  "createdBy": "nick"
}
```

**Rules**

* version must be published
* auto-create instance results rows for item nodes

---

## 2.2.02 GET instance summary

**GET** `/api/v1/checklist-instances/:instanceId`

**Response**

```json
{
  "instance": {
    "id": "uuid",
    "status": "pass|warning|fail|blocked|incomplete",
    "blockingCount": 0,
    "failCount": 2,
    "warningCount": 5,
    "lastRunAt": "iso"
  }
}
```

---

## 2.2.03 GET instance tree (nodes + merged results)

**GET** `/api/v1/checklist-instances/:instanceId/tree`

**Response**

* template nodes
* each `item` includes:

  * result status/severity
  * output summary/stats/rows sample
  * note/checkedBy

---

## 2.2.04 Issues queue (flattened)

**GET** `/api/v1/checklist-instances/:instanceId/issues`

**Query filters**

* `severity=blocking,warning`
* `sectionId=uuid`
* `schema=public`
* `table=users`
* `status=blocked,fail,warning`

**Sort**

* blocked → fail → warning, most recent first

**Response**

```json
{
  "issues": [
    {
      "resultId": "uuid",
      "code": "FK_NOT_INDEXED",
      "title": "FK columns missing index",
      "severity": "warning",
      "status": "warning",
      "focus": { "type": "relationship", "key": "public.orders(user_id)->public.users(id)" }
    }
  ]
}
```

---

## 2.2.05 PATCH manual item updates

**PATCH** `/api/v1/checklist-instance-results/:resultId`

**Body**

```json
{
  "status": "pass|warning|fail|blocked|unchecked",
  "note": "…",
  "checkedBy": "nick"
}
```

**Rules**

* recompute instance rollup

### Evidence attach endpoint (optional, v1)

**POST** `/api/v1/checklist-instance-results/:resultId/evidence`

**Body**

```json
{
  "type": "link|text",
  "label": "Investigation",
  "value": "https://…"
}
```

---

# 2.3 Checks runtime

## 2.3.01 Check registry (builtins)

**Internal structure**

```ts
type CheckCtx = {
  targetPool: Pool;
  schemas: string[];
  scopeType: string;
  scopeRef: any;
  variables: Record<string, any>;
};

type CheckResult = {
  nodeId: string;
  status: 'pass'|'warning'|'fail'|'blocked';
  severity: 'warning'|'error'|'blocking';
  outputSummary?: string;
  outputStats?: any;
  outputRows?: any[];
  targetRef?: { targets: any[] };
};

type BuiltinCheck = {
  id: string;
  title: string;
  run: (ctx: CheckCtx) => Promise<CheckResult>;
};
```

## 2.3.02 Run endpoints

### Run all checks

**POST** `/api/v1/checklist-instances/:instanceId/run`

**Body**

```json
{
  "targetDatabaseUrl": "postgresql://…",
  "schemas": ["public","stats"],
  "mode": "all"
}
```

### Run selected node IDs

**POST** `/api/v1/checklist-instances/:instanceId/run`

**Body**

```json
{
  "targetDatabaseUrl": "postgresql://…",
  "schemas": ["public"],
  "mode": "items",
  "nodeIds": ["uuid","uuid"]
}
```

---

## 2.3.03 SQL template runner (for sql checks)

You’ll need this to ship the builder.

**Features**

* variable injection: `{{schema}}`, `{{table}}`, thresholds
* timeout: 2–5 seconds
* max rows returned: 50
* mapping:

  * guess `schema/table/column` fields from result columns
  * store under `target_ref.targets`

---

## 2.3.04 SQL test endpoint (for builder)

**POST** `/api/v1/sql/test`

**Body**

```json
{
  "targetDatabaseUrl": "postgresql://…",
  "sql": "SELECT …",
  "rowCap": 25,
  "timeoutMs": 2500
}
```

**Response**

```json
{
  "rows": [ ... ],
  "columns": [
    { "name": "schema", "type": "text" },
    { "name": "table", "type": "text" }
  ],
  "mappingSuggestions": {
    "targetKind": "table",
    "fields": ["schema","table"]
  }
}
```

---

# 2.4 ERD binding endpoints (Minimum)

## 2.4.01 Snapshot (ERD data)

**POST** `/api/v1/introspect/postgres/snapshot`

Body: `{ targetDatabaseUrl, schemas[] }`
Response: `{ snapshot }`

## 2.4.02 Annotations (overlay)

**GET** `/api/v1/checklist-instances/:instanceId/annotations`

Response: `{ tables[], relationships[] }`

## 2.4.03 Layout persistence

* **GET** `/api/v1/checklist-instances/:instanceId/erd-layout`
* **PUT** `/api/v1/checklist-instances/:instanceId/erd-layout`

---

## What I’d build next (so the builder can ship)

If you say “2.3 SQL runner”, I’ll produce the full implementation for:

* `POST /api/v1/sql/test`
* SQL template interpolation + safe variable injection
* timeout + row cap
* mapping suggestion heuristics
* how to store mapping on a node (`result_mapping`)
