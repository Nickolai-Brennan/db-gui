Start with **1) App DB schema**. Without it you can’t persist templates/versions/instances/results cleanly, and everything else (JSON, UI) becomes guessy.

Below is a **development-ready Postgres schema** for the Checklist Builder + runtime. It’s minimal, but future-proof (versioning, evidence, overrides, per-scope instances).

---

## App DB Schema v1 (Postgres)

### 0) Extensions (optional but handy)

```sql
CREATE EXTENSION IF NOT EXISTS pgcrypto; -- gen_random_uuid()
```

---

## 1) Workspaces (optional but recommended)

```sql
CREATE TABLE workspaces (
  id           uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  name         text NOT NULL,
  created_at   timestamptz NOT NULL DEFAULT now()
);
```

---

## 2) Connections (your DB targets)

```sql
CREATE TABLE connections (
  id            uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  workspace_id  uuid NOT NULL REFERENCES workspaces(id) ON DELETE CASCADE,
  name          text NOT NULL,
  dialect       text NOT NULL CHECK (dialect IN ('postgres','mysql','sqlserver','sqlite')),
  host          text,
  port          integer,
  database_name text,
  created_at    timestamptz NOT NULL DEFAULT now()
);

CREATE INDEX connections_workspace_idx ON connections(workspace_id);
```

---

## 3) Checklist Templates (identity + ownership)

```sql
CREATE TABLE checklist_templates (
  id            uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  workspace_id  uuid NOT NULL REFERENCES workspaces(id) ON DELETE CASCADE,
  slug          text NOT NULL,                -- e.g. "erd-health"
  title         text NOT NULL,                -- e.g. "ERD Health"
  description   text,
  is_system     boolean NOT NULL DEFAULT false, -- built-in templates
  created_at    timestamptz NOT NULL DEFAULT now(),
  UNIQUE (workspace_id, slug)
);

CREATE INDEX checklist_templates_workspace_idx ON checklist_templates(workspace_id);
```

---

## 4) Template Versions (immutable published versions)

* Drafts are allowed (`status='draft'`)
* Publish locks it (`status='published'`)

```sql
CREATE TABLE checklist_template_versions (
  id             uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  template_id    uuid NOT NULL REFERENCES checklist_templates(id) ON DELETE CASCADE,
  version        text NOT NULL, -- "1.0.0"
  status         text NOT NULL CHECK (status IN ('draft','published','archived')),
  created_by     text,          -- user id/email (simple v1)
  created_at     timestamptz NOT NULL DEFAULT now(),
  published_at   timestamptz,
  UNIQUE (template_id, version)
);

CREATE INDEX checklist_template_versions_template_idx ON checklist_template_versions(template_id);
```

---

## 5) Template Nodes (infinite-depth tree)

Single table for Sections/Subsections/Items. Depth is represented by `parent_id` and ordering via `sort_order`.

```sql
CREATE TABLE checklist_nodes (
  id                 uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  template_version_id uuid NOT NULL REFERENCES checklist_template_versions(id) ON DELETE CASCADE,

  parent_id           uuid REFERENCES checklist_nodes(id) ON DELETE CASCADE,
  sort_order          integer NOT NULL DEFAULT 0,

  node_type           text NOT NULL CHECK (node_type IN ('group','item')),
  title               text NOT NULL,
  description         text,

  -- Item-only fields (NULL for groups)
  item_type           text CHECK (item_type IN ('manual','automatic','hybrid')),
  severity            text CHECK (severity IN ('info','warning','error','blocking')),
  blocks_action       boolean,
  required            boolean,

  -- scope / targeting
  scope_type          text CHECK (scope_type IN ('diagram','schema','table','column','relationship','migration_step')),
  target_selector     jsonb,   -- describes "all tables", "each fk", etc. (see below)

  -- automatic checks
  check_kind          text,    -- e.g. "BUILTIN" or "SQL_TEMPLATE"
  check_ref           text,    -- e.g. builtin id "FK_NOT_INDEXED" or "NO_PRIMARY_KEY"
  sql_template        text,    -- for SQL_TEMPLATE
  result_mapping      jsonb,   -- maps returned cols to target (schema/table/column/fk)
  pass_fail_rule      jsonb,   -- rule engine config

  -- fix actions
  fix_kind            text CHECK (fix_kind IN ('none','manual','auto_sql')),
  fix_instructions    text,
  fix_sql_template    text,

  created_at          timestamptz NOT NULL DEFAULT now()
);

CREATE INDEX checklist_nodes_version_idx ON checklist_nodes(template_version_id);
CREATE INDEX checklist_nodes_parent_idx ON checklist_nodes(parent_id);
```

### Recommended `target_selector` shape (examples)

* All tables in included schemas:

```json
{"mode":"all_tables"}
```

* Each foreign key edge:

```json
{"mode":"each_relationship","kind":"foreign_key"}
```

* Specific table:

```json
{"mode":"table","schema":"stats","table":"game"}
```

### Recommended `result_mapping` shape

Maps SQL result columns to targets:

```json
{"schema_col":"schema","table_col":"table","column_col":"column","fk_name_col":"fk_name"}
```

### Recommended `pass_fail_rule` shape

Examples:

* Any rows returned => FAIL:

```json
{"type":"rows_returned","fail_if_gt":0}
```

* Violations count column:

```json
{"type":"numeric_threshold","column":"violating_rows","fail_if_gt":0}
```

---

## 6) Checklist Instances (a run tied to a scope object)

Instances are created from a **published template version** for a specific connection/scope.

```sql
CREATE TABLE checklist_instances (
  id                   uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  workspace_id          uuid NOT NULL REFERENCES workspaces(id) ON DELETE CASCADE,
  connection_id         uuid REFERENCES connections(id) ON DELETE SET NULL,

  template_version_id   uuid NOT NULL REFERENCES checklist_template_versions(id),

  -- scope binding
  scope_type            text NOT NULL CHECK (scope_type IN ('diagram','schema','table','migration_step')),
  scope_ref             jsonb NOT NULL,  -- e.g. {"schemas":["public","stats"],"diagramId":"..."} or {"schema":"stats","table":"game"}

  status                text NOT NULL CHECK (status IN ('incomplete','pass','warning','fail','blocked')),
  blocking_count        integer NOT NULL DEFAULT 0,
  warning_count         integer NOT NULL DEFAULT 0,
  fail_count            integer NOT NULL DEFAULT 0,

  created_by            text,
  created_at            timestamptz NOT NULL DEFAULT now(),
  last_run_at           timestamptz
);

CREATE INDEX checklist_instances_workspace_idx ON checklist_instances(workspace_id);
CREATE INDEX checklist_instances_connection_idx ON checklist_instances(connection_id);
CREATE INDEX checklist_instances_template_version_idx ON checklist_instances(template_version_id);
```

---

## 7) Instance Results (per item, per run)

Stores the *latest* evaluation for each item plus evidence links.

```sql
CREATE TABLE checklist_instance_results (
  id              uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  instance_id      uuid NOT NULL REFERENCES checklist_instances(id) ON DELETE CASCADE,
  node_id          uuid NOT NULL REFERENCES checklist_nodes(id) ON DELETE CASCADE, -- must be item

  status           text NOT NULL CHECK (status IN ('unchecked','pass','warning','fail','blocked')),
  severity         text NOT NULL CHECK (severity IN ('info','warning','error','blocking')),

  -- targeting for highlighting / deep links
  target_ref       jsonb,     -- e.g. {"kind":"table","schema":"stats","table":"game"} or relationship signature

  -- execution
  run_type         text NOT NULL CHECK (run_type IN ('manual','automatic','hybrid')),
  ran_at           timestamptz,
  duration_ms      integer,

  -- automatic check outputs
  output_summary   text,
  output_rows      jsonb,     -- small sample of failing rows (cap in app)
  output_stats     jsonb,     -- counts, etc.

  -- manual/hybrid evidence
  note             text,
  checked_by       text,

  updated_at       timestamptz NOT NULL DEFAULT now(),
  UNIQUE (instance_id, node_id)
);

CREATE INDEX checklist_instance_results_instance_idx ON checklist_instance_results(instance_id);
CREATE INDEX checklist_instance_results_status_idx ON checklist_instance_results(status);
```

---

## 8) Evidence Attachments (optional v1, but valuable)

```sql
CREATE TABLE checklist_evidence (
  id          uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  result_id   uuid NOT NULL REFERENCES checklist_instance_results(id) ON DELETE CASCADE,
  kind        text NOT NULL CHECK (kind IN ('note','file','link','sql')),
  label       text,
  uri         text,      -- file path or URL
  content     text,      -- optional inline text/sql
  created_at  timestamptz NOT NULL DEFAULT now()
);

CREATE INDEX checklist_evidence_result_idx ON checklist_evidence(result_id);
```

---

## 9) Overrides / Approvals (for Prod gates later)

```sql
CREATE TABLE checklist_overrides (
  id           uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  instance_id  uuid NOT NULL REFERENCES checklist_instances(id) ON DELETE CASCADE,
  node_id      uuid NOT NULL REFERENCES checklist_nodes(id) ON DELETE CASCADE,
  reason       text NOT NULL,
  approved_by  text NOT NULL,
  approved_at  timestamptz NOT NULL DEFAULT now()
);

CREATE INDEX checklist_overrides_instance_idx ON checklist_overrides(instance_id);
```

---

# What you can build immediately with this

### Day 1 development path

1. CRUD for **templates**
2. Create **template version**
3. Add/edit **nodes** (tree builder)
4. Instantiate checklist for a connection/scope
5. Store results + show dashboard counts
6. Bind results to ERD highlights using `target_ref`

---

# Next “must have” for development (I’ll provide next)

A **minimal JSON contract** for the front-end tree + a “hydrated” API response:

* nested nodes
* computed status
* issues list for dashboard
* deep links

Say **“API contract”** and I’ll output:

* REST or GraphQL shape (your choice)
* endpoints/queries/mutations
* example payloads for Template Builder + Dashboard + ERD annotations
